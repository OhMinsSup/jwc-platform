"use client";

import {
	Button,
	Card,
	CardContent,
	CardHeader,
	CardTitle,
	FormControl,
	FormDescription,
	FormField,
	FormItem,
	FormLabel,
	FormMessage,
	Input,
	RadioGroup,
	RadioGroupItem,
	Select,
	SelectContent,
	SelectItem,
	SelectTrigger,
	SelectValue,
	Separator,
	Textarea,
} from "@jwc/ui";
import { onSuccess } from "@orpc/client";
import { useServerAction } from "@orpc/react/hooks";
import { useSuspenseQuery } from "@tanstack/react-query";
import { useRouter } from "next/navigation";
import React, { useCallback, useMemo, useState } from "react";
import { useFormContext } from "react-hook-form";
import { upsertClubForm } from "~/api/actions/clubForms";
import {
	ClubFormProvider,
	type FormFieldSchema,
} from "~/components/forms/FormContext/ClubFormContext";
import { useORPC } from "~/libs/orpc/react";
import type { Component as ClubComponent, ComponentData } from "~/types/club";

interface ClubSelectionProps {
	id: string | number;
}

// ÏÉÅÏàò Ï†ïÏùò
const DEPARTMENT_OPTIONS = [
	{ value: "Ï≤≠ÎÖÑ1Î∂Ä", label: "Ï≤≠ÎÖÑ 1Î∂Ä" },
	{ value: "Ï≤≠ÎÖÑ2Î∂Ä", label: "Ï≤≠ÎÖÑ 2Î∂Ä" },
	{ value: "Í∏∞ÌÉÄ", label: "Í∏∞ÌÉÄ" },
] as const;

const FORM_PLACEHOLDERS = {
	name: "Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî",
	phone: "Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî",
	department: "Î∂ÄÏÑúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî",
	ageGroup: "ÎòêÎûòÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî (Ïòà: 93ÎòêÎûò)",
	component: "ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî",
	description: "ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî...",
} as const;

const ERROR_MESSAGES = {
	name: "Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî",
	phone: "Ïó∞ÎùΩÏ≤òÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî",
	department: "Î∂ÄÏÑúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî",
	ageGroup: "ÎòêÎûòÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî",
	submit: "Ïã†Ï≤≠ Ï†úÏ∂úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.",
	clubNotFound: "ÎèôÏïÑÎ¶¨ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.",
} as const;

const SUCCESS_MESSAGE = "Ïã†Ï≤≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†úÏ∂úÎêòÏóàÏäµÎãàÎã§." as const;

// Rich Text ÎÇ¥Ïö©ÏùÑ ÏùºÎ∞ò ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò (ÏµúÏ†ÅÌôî)
const extractTextFromRichText = (content: unknown): string => {
	if (!content || typeof content !== "object") return "";

	const contentObj = content as { root?: { children?: unknown[] } };
	if (!contentObj.root?.children?.length) return "";

	const extractText = (node: unknown): string => {
		if (!node || typeof node !== "object") return "";

		const nodeObj = node as {
			type?: string;
			text?: string;
			children?: unknown[];
		};

		switch (nodeObj.type) {
			case "text":
				return nodeObj.text || "";
			case "linebreak":
				return "\n";
			default:
				return nodeObj.children?.map(extractText).join("") || "";
		}
	};

	return contentObj.root.children.map(extractText).join("\n").trim();
};

// =============================================================================
// üìã Ìèº ÌïÑÎìú Ïª¥Ìè¨ÎÑåÌä∏Îì§
// =============================================================================

// Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏûÖÎ†• ÌïÑÎìú Ïª¥Ìè¨ÎÑåÌä∏
const BasicInfoFields = React.memo(() => {
	const { control } = useFormContext<FormFieldSchema>();

	return (
		<div className="space-y-6">
			<h3 className="font-semibold text-lg">Ïã†Ï≤≠Ïûê Ï†ïÎ≥¥</h3>
			<div className="grid gap-4 md:grid-cols-2">
				<FormField
					control={control}
					name="name"
					render={({ field }) => (
						<FormItem>
							<FormLabel className="font-semibold">
								Ïù¥Î¶Ñ <span className="text-red-500">*</span>
							</FormLabel>
							<FormControl>
								<Input placeholder={FORM_PLACEHOLDERS.name} {...field} />
							</FormControl>
							<FormMessage />
						</FormItem>
					)}
				/>

				<FormField
					control={control}
					name="phone"
					render={({ field }) => (
						<FormItem>
							<FormLabel className="font-semibold">
								Ïó∞ÎùΩÏ≤ò <span className="text-red-500">*</span>
							</FormLabel>
							<FormControl>
								<Input
									placeholder={FORM_PLACEHOLDERS.phone}
									type="tel"
									{...field}
								/>
							</FormControl>
							<FormMessage />
						</FormItem>
					)}
				/>
			</div>

			<div className="grid gap-4 md:grid-cols-2">
				<FormField
					control={control}
					name="department"
					render={({ field }) => (
						<FormItem>
							<FormLabel className="font-semibold">
								Î∂ÄÏÑú <span className="text-red-500">*</span>
							</FormLabel>{" "}
							<Select
								onValueChange={field.onChange}
								value={String(field.value || "")}
							>
								<FormControl>
									<SelectTrigger>
										<SelectValue placeholder={FORM_PLACEHOLDERS.department} />
									</SelectTrigger>
								</FormControl>
								<SelectContent>
									{DEPARTMENT_OPTIONS.map((option) => (
										<SelectItem key={option.value} value={option.value}>
											{option.label}
										</SelectItem>
									))}
								</SelectContent>
							</Select>
							<FormMessage />
						</FormItem>
					)}
				/>

				<FormField
					control={control}
					name="ageGroup"
					render={({ field }) => (
						<FormItem>
							<FormLabel className="font-semibold">
								ÎòêÎûò <span className="text-red-500">*</span>
							</FormLabel>
							<FormControl>
								<Input placeholder={FORM_PLACEHOLDERS.ageGroup} {...field} />
							</FormControl>
							<FormMessage />
						</FormItem>
					)}
				/>
			</div>
		</div>
	);
});

// ÏÑ†ÌÉùÌòï ÏßàÎ¨∏ ÌïÑÎìú Ïª¥Ìè¨ÎÑåÌä∏
const SelectQuestionField = React.memo(
	({
		component,
		fieldName,
	}: {
		component: ClubComponent;
		fieldName: string;
	}) => {
		const { control } = useFormContext<FormFieldSchema>();
		const dataFieldName = `data.${fieldName}` as const;

		return (
			<FormField
				control={control}
				name={dataFieldName}
				render={({ field }) => (
					<FormItem className="space-y-3">
						<FormLabel className="font-semibold text-base">
							{component.title}
							{component.data?.required && (
								<span className="ml-1 text-red-500">*</span>
							)}
						</FormLabel>
						{component.description && (
							<FormDescription>{component.description}</FormDescription>
						)}
						<Select
							onValueChange={field.onChange}
							value={String(field.value || "")}
						>
							<FormControl>
								<SelectTrigger className="w-full">
									<SelectValue placeholder={FORM_PLACEHOLDERS.component} />
								</SelectTrigger>
							</FormControl>
							<SelectContent>
								{component.data?.data?.map(
									(option: ComponentData, optionIndex: number) => (
										<SelectItem
											key={`select-${component.id}-${option.id || optionIndex}`}
											value={option.name}
										>
											{option.name}
										</SelectItem>
									)
								)}
							</SelectContent>
						</Select>
						<FormMessage />
					</FormItem>
				)}
			/>
		);
	}
);

// ÏÑúÏà†Ìòï ÏßàÎ¨∏ ÌïÑÎìú Ïª¥Ìè¨ÎÑåÌä∏
const TextareaQuestionField = React.memo(
	({
		component,
		fieldName,
	}: {
		component: ClubComponent;
		fieldName: string;
	}) => {
		const { control } = useFormContext<FormFieldSchema>();
		const dataFieldName = `data.${fieldName}` as const;

		return (
			<FormField
				control={control}
				name={dataFieldName}
				render={({ field }) => (
					<FormItem className="space-y-3">
						<FormLabel className="font-semibold text-base">
							{component.title}
							{component.data?.required && (
								<span className="ml-1 text-red-500">*</span>
							)}
						</FormLabel>
						{component.description && (
							<FormDescription>{component.description}</FormDescription>
						)}
						<FormControl>
							<Textarea
								placeholder={FORM_PLACEHOLDERS.description}
								className="min-h-[120px] resize-none"
								{...field}
								value={String(field.value || "")}
							/>
						</FormControl>
						<FormMessage />
					</FormItem>
				)}
			/>
		);
	}
);

// ÎùºÎîîÏò§ Î≤ÑÌäº ÏßàÎ¨∏ ÌïÑÎìú Ïª¥Ìè¨ÎÑåÌä∏
const RadioQuestionField = React.memo(
	({
		component,
		fieldName,
	}: {
		component: ClubComponent;
		fieldName: string;
	}) => {
		const { control } = useFormContext<FormFieldSchema>();
		const dataFieldName = `data.${fieldName}` as const;

		return (
			<FormField
				control={control}
				name={dataFieldName}
				render={({ field }) => (
					<FormItem className="space-y-3">
						<FormLabel className="font-semibold text-base">
							{component.title}
							{component.data?.required && (
								<span className="ml-1 text-red-500">*</span>
							)}
						</FormLabel>
						{component.description && (
							<FormDescription>{component.description}</FormDescription>
						)}
						<FormControl>
							<RadioGroup
								onValueChange={field.onChange}
								value={String(field.value || "")}
								className="flex flex-col space-y-2"
							>
								{component.data?.data?.map(
									(option: ComponentData, optionIndex: number) => (
										<div
											key={`radio-${component.id}-${option.id || optionIndex}`}
											className="flex items-center space-x-3"
										>
											<RadioGroupItem
												value={option.name}
												id={`${component.id}-${option.id || optionIndex}`}
											/>
											<label
												htmlFor={`${component.id}-${option.id || optionIndex}`}
												className="cursor-pointer font-normal text-sm"
											>
												{option.name}
											</label>
										</div>
									)
								)}
							</RadioGroup>
						</FormControl>
						<FormMessage />
					</FormItem>
				)}
			/>
		);
	}
);

// DisplayName ÏÑ§Ï†ï
BasicInfoFields.displayName = "BasicInfoFields";
SelectQuestionField.displayName = "SelectQuestionField";
TextareaQuestionField.displayName = "TextareaQuestionField";
RadioQuestionField.displayName = "RadioQuestionField";

// =============================================================================
// üéØ UI Ïª¥Ìè¨ÎÑåÌä∏Îì§
// =============================================================================

// ÌÅ¥ÎüΩ Ï†ïÎ≥¥ Ìó§Îçî Ïª¥Ìè¨ÎÑåÌä∏
const ClubInfoHeader = React.memo(
	({
		club,
		clubDescription,
	}: {
		club: { title: string };
		clubDescription: string;
	}) => (
		<Card className="mb-8 shadow-lg">
			<CardHeader>
				<div className="flex items-center justify-between">
					<div className="flex items-center space-x-3">
						<div className="flex h-12 w-12 items-center justify-center rounded-full bg-primary/10">
							<svg
								className="h-6 w-6 text-primary"
								fill="currentColor"
								viewBox="0 0 24 24"
							>
								<title>ÎèôÏïÑÎ¶¨ ÏïÑÏù¥ÏΩò</title>
								<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
							</svg>
						</div>
						<div>
							<CardTitle className="text-2xl">{club.title}</CardTitle>
						</div>
					</div>
				</div>
			</CardHeader>
			{clubDescription && (
				<CardContent className="pt-0">
					<div className="rounded-lg bg-muted/50 p-4">
						<h3 className="mb-3 font-semibold text-base">ÎèôÏïÑÎ¶¨ ÏÜåÍ∞ú</h3>
						<div className="whitespace-pre-line text-muted-foreground text-sm leading-relaxed">
							{clubDescription}
						</div>
					</div>
				</CardContent>
			)}
		</Card>
	)
);

// Ìèº Ìó§Îçî Ïª¥Ìè¨ÎÑåÌä∏
const FormHeader = React.memo(() => (
	<CardHeader>
		<div className="flex items-center space-x-3">
			<div className="flex h-8 w-8 items-center justify-center rounded-full bg-blue-100">
				<svg
					className="h-4 w-4 text-blue-600"
					fill="currentColor"
					viewBox="0 0 24 24"
				>
					<title>Ìèº ÏïÑÏù¥ÏΩò</title>
					<path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
				</svg>
			</div>
			<CardTitle className="text-xl">Ïã†Ï≤≠ÏÑú ÏûëÏÑ±</CardTitle>
		</div>
		<Separator />
	</CardHeader>
));

// Ìèº Ïï°ÏÖò Î≤ÑÌäºÎì§ Ïª¥Ìè¨ÎÑåÌä∏
const FormActionButtons = React.memo(
	({
		isSubmitting,
		onGoBack,
	}: {
		isSubmitting: boolean;
		onGoBack: () => void;
	}) => (
		<div className="flex flex-col gap-4 sm:flex-row sm:justify-between">
			<Button
				type="button"
				variant="outline"
				onClick={onGoBack}
				className="flex items-center gap-2"
			>
				<svg className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
					<title>Îí§Î°úÍ∞ÄÍ∏∞</title>
					<path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
				</svg>
				Ïù¥Ï†ÑÏúºÎ°ú
			</Button>

			<Button
				type="submit"
				disabled={isSubmitting}
				className="flex items-center gap-2"
			>
				{isSubmitting ? (
					<>
						<div className="h-4 w-4 animate-spin rounded-full border-2 border-background border-t-transparent" />
						Ï†úÏ∂ú Ï§ë...
					</>
				) : (
					<>
						<svg className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
							<title>Ï†úÏ∂ú</title>
							<path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
						</svg>
						Ïã†Ï≤≠ ÏôÑÎ£å
					</>
				)}
			</Button>
		</div>
	)
);

// DisplayName ÏÑ§Ï†ï
ClubInfoHeader.displayName = "ClubInfoHeader";
FormHeader.displayName = "FormHeader";
FormActionButtons.displayName = "FormActionButtons";

// =============================================================================
// üîß Ïª§Ïä§ÌÖÄ ÌõÖÎì§
// =============================================================================

// ÌÅ¥ÎüΩ Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî ÌõÖ
const useClubData = (id: string | number) => {
	const orpc = useORPC();

	const { data: clubResponse } = useSuspenseQuery(
		orpc.clubs.getById.queryOptions({ input: { id } })
	);

	const club = useMemo(() => clubResponse?.data, [clubResponse?.data]);
	const components = useMemo(() => club?.components || [], [club?.components]);
	const clubDescription = useMemo(
		() => extractTextFromRichText(club?.content),
		[club?.content]
	);

	return { club, components, clubDescription };
};

// =============================================================================
// üéØ Î©îÏù∏ Ïª¥Ìè¨ÎÑåÌä∏ (Context Í∏∞Î∞ò)
// =============================================================================

// ClubSelection ÎÇ¥Î∂Ä Ïª¥Ìè¨ÎÑåÌä∏ (ÌëúÏ§Ä React Hook Form ÏÇ¨Ïö©)
function ClubSelectionContent({ id }: { id: string | number }) {
	const router = useRouter();
	const methods = useFormContext<FormFieldSchema>();

	// Ïª§Ïä§ÌÖÄ ÌõÖÎì§ ÏÇ¨Ïö©
	const { club, components, clubDescription } = useClubData(id);

	// ÏÑúÎ≤Ñ Ïï°ÏÖò ÏÑ§Ï†ï
	const { execute, status } = useServerAction(upsertClubForm, {
		interceptors: [
			onSuccess((ctx) => {
				if (ctx.success) {
					router.push(`/form/club/${id}/success`);
				}
			}),
		],
	});

	// Ìèº Ï†úÏ∂ú Ìï∏Îì§Îü¨
	const onSubmit = useCallback(
		async (data: FormFieldSchema) => {
			try {
				// data.dataÏóêÏÑú component_ ÌïÑÎìúÎì§ Ï∂îÏ∂ú
				const componentData = Object.fromEntries(
					Object.entries(data.data || {}).filter(([key]) =>
						key.startsWith("component_")
					)
				);

				const clubFormData = {
					clubId: id.toString(),
					name: data.name || "",
					phone: data.phone || "",
					department: data.department || "",
					ageGroup: data.ageGroup || "",
					data: componentData,
				};

				// ÏÑúÎ≤Ñ Ïï°ÏÖò Ïã§Ìñâ
				await execute(clubFormData);
			} catch (error) {
				console.error("ÎèôÏïÑÎ¶¨ Ïã†Ï≤≠ Ï†úÏ∂ú Ïã§Ìå®:", error);
				const errorMessage =
					error instanceof Error ? error.message : ERROR_MESSAGES.submit;
				alert(errorMessage);
			}
		},
		[id, execute]
	);

	// Îí§Î°úÍ∞ÄÍ∏∞ Ìï∏Îì§Îü¨
	const handleGoBack = useCallback(() => {
		router.back();
	}, [router]);

	// ÎèôÏ†Å Ïª¥Ìè¨ÎÑåÌä∏ Î†åÎçîÎßÅ
	const renderDynamicComponents = useCallback(() => {
		if (components.length === 0) return null;

		return (
			<>
				<Separator />
				<div className="space-y-6">
					<h3 className="font-semibold text-lg">ÎèôÏïÑÎ¶¨Î≥Ñ ÏßàÎ¨∏</h3>
					{components.map((component: ClubComponent, index: number) => {
						const fieldName = `component_${component.id}`;

						return (
							<div key={component.id}>
								{component.type === "select" ? (
									<SelectQuestionField
										component={component}
										fieldName={fieldName}
									/>
								) : component.type === "radio" ? (
									<RadioQuestionField
										component={component}
										fieldName={fieldName}
									/>
								) : component.type === "description" ? (
									<TextareaQuestionField
										component={component}
										fieldName={fieldName}
									/>
								) : null}
								{index < components.length - 1 && (
									<Separator className="mt-6" />
								)}
							</div>
						);
					})}
				</div>
			</>
		);
	}, [components]);

	// Î°úÎî© ÏÉÅÌÉú Ï≤òÎ¶¨
	if (!club) {
		return (
			<div className="container mx-auto mt-10 max-w-4xl px-4 py-8">
				<Card className="shadow-lg">
					<CardContent className="p-8 text-center">
						<p className="text-muted-foreground">
							{ERROR_MESSAGES.clubNotFound}
						</p>
					</CardContent>
				</Card>
			</div>
		);
	}

	return (
		<div className="container mx-auto mt-10 max-w-4xl px-4 py-8">
			{/* ÎèôÏïÑÎ¶¨ Ï†ïÎ≥¥ Ìó§Îçî */}
			<ClubInfoHeader club={club} clubDescription={clubDescription} />

			{/* Ïã†Ï≤≠ Ìèº */}
			<Card className="shadow-lg">
				<FormHeader />
				<CardContent className="p-8">
					<form onSubmit={methods.handleSubmit(onSubmit)} className="space-y-8">
						{/* Í∏∞Î≥∏ ÌïÑÎìúÎì§ */}
						<BasicInfoFields />

						{/* ÎèôÏ†Å Ïª¥Ìè¨ÎÑåÌä∏ ÌïÑÎìúÎì§ */}
						{renderDynamicComponents()}

						<Separator className="my-8" />

						{/* Ïï°ÏÖò Î≤ÑÌäºÎì§ */}
						<FormActionButtons
							isSubmitting={status === "pending"}
							onGoBack={handleGoBack}
						/>
					</form>
				</CardContent>
			</Card>
		</div>
	);
}

export default function ClubSelection({ id }: ClubSelectionProps) {
	return (
		<ClubFormProvider
			defaultValues={{
				// @ts-expect-error clubId is a string or number
				clubId: id,
			}}
		>
			<ClubSelectionContent id={id} />
		</ClubFormProvider>
	);
}
